<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advisor/Instructor/Reviewer Dashboard</title>
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .dashboard-section { margin-bottom: 30px; }
        .dashboard-section h3, .dashboard-section h5 { border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 15px; }
        details summary { cursor: pointer; }
        .card-header i { margin-right: 5px; }
    </style>
</head>
<body class="bg-light">


    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <h2 class="text-primary">
                <i class="bi bi-person-badge-fill"></i> Advisor/Instructor/Reviewer Dashboard
            </h2>
             <div>
                 <span class="me-3 text-muted">Logged in as {{ role }}</span>
                 <a href="{{ url_for('view_transcript') }}" class="btn btn-sm btn-outline-info"><i class="bi bi-journal-text"></i> View Transcripts</a>
                 <a href="{{ url_for('view_pending_initial_forms') }}" class="btn btn-sm btn-outline-warning"><i class="bi bi-hourglass-split"></i> Pending Initial Plans</a>
                 <a href="{{ url_for('audit') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-clipboard-check"></i> Audit Student</a>
                 <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</a>
             </div>
        </div>

         <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}


        {% if advisor %}
            <h4>Welcome, {{ advisor.first_name }} {{ advisor.last_name }}</h4>
        {% else %}
             <h4>Welcome!</h4>
        {% endif %}

        <div class="dashboard-section card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-clipboard-data-fill"></i> Application Review</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('advisor_instructor_reviewer_home') }}" class="mb-3">
                     <div class="input-group">
                        <input type="text" class="form-control" name="search" placeholder="Search applications by name, student ID, or degree..." value="{{ search_term if search_term }}">
                        <button class="btn btn-success" type="submit"><i class="bi bi-search"></i></button>
                        {% if search_term %}
                        <a href="{{ url_for('advisor_instructor_reviewer_home') }}" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Clear</a>
                        {% endif %}
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Student ID</th>
                                <th>Applicant</th>
                                <th>Program</th>
                                <th>Admission Term</th>
                                <th>Status</th>
                                <th>Docs</th>
                                <th>Reviews</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if review_applications %} 
                              {% for app in review_applications %}
                                <tr>
                                  <td class="font-monospace">{{ app.student_id }}</td>
                                  <td>
                                    <strong>{{ app.last_name }}, {{ app.first_name }}</strong>
                                    <div class="text-muted small">{{ app.email }}</div>
                                  </td>
                                  <td>
                                    <span class="badge {% if app.degree_program == 'PhD' %}bg-primary{% else %}bg-secondary{% endif %}">
                                      {{ app.degree_program }}
                                    </span>
                                  </td>
                                  <td>{{ app.admission_semester }} {{ app.admission_year }}</td>
                                  <td>
                                    <span class="badge rounded-pill {% if app.status == 'Admitted' %}bg-success{% elif app.status == 'Rejected' %}bg-danger{% elif 'Under Review' in app.status %}bg-info{% else %}bg-warning text-dark{% endif %}">
                                      {{ app.status }}
                                    </span>
                                  </td>
                                  <td> 
                                     <span class="badge {{ 'bg-success' if app.transcript_received else 'bg-secondary' }}" title="Transcript">{{ 'T' if app.transcript_received else 't' }}</span>
                                     <span class="badge {{ 'bg-success' if app.recommendation_received else 'bg-secondary' }}" title="Recommendation(s)">{{ 'R' if app.recommendation_received else 'r' }}</span>
                                  </td>
                                  <td>
                                    {% if app.review_count > 0 %}
                                      <span class="badge bg-info">{{ app.review_count }}</span>
                                    {% else %}
                                      <span class="badge bg-light text-dark">0</span>
                                    {% endif %}
                                  </td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <a href="{{ url_for('reviewer.application_detail', application_id=app.application_id) }}" class="btn btn-primary" title="View/Review Application">
                                        <i class="bi bi-eye-fill"></i> Review
                                      </a>
                                    </div>
                                  </td>
                                </tr>
                              {% endfor %}
                            {% else %}
                              <tr>
                                <td colspan="8" class="text-center py-4 text-muted">
                                  <i class="bi bi-info-circle fs-3"></i><br>
                                  {% if search_term %}
                                    No applications found matching your criteria for review.
                                  {% else %}
                                    No applications currently requiring review.
                                  {% endif %}
                                </td>
                              </tr>
                            {% endif %}
                          </tbody>
                    </table>
                </div>
            </div>
        </div> 



        <div class="dashboard-section card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-people-fill"></i> Advisee Management</h5>
            </div>
            <div class="card-body">
                <div class="row">
                     <div class="col-md-6">
                        <h3>Advisees</h3>
                        {% if advisees %}
                            {% for student in advisees %}
                            <details class="mb-2 p-2 border rounded">
                                <summary><strong>{{ student.first_name }} {{ student.last_name }}</strong> (ID: {{ student.userID }})</summary>
                                <ul class="list-unstyled mt-2 ms-3">
                                    <li>Address: {{ student.address | default('N/A', true) }}</li>
                                    <li>Program: {{ student.program | default('N/A', true) }}</li>
                                    <li>Graduation Date: {{ student.graduationDate | default('N/A', true) }}</li>
                                     <li>
                                        Thesis Approval:
                                        {% if student.approved == 1 %}
                                            <span class="badge bg-success">Yes</span>
                                             <form method="POST" action="/approveThesis" style="display:inline;">
                                                <input type="hidden" name="studentID" value="{{ student.userID }}">
                                                <button type="submit" class="btn btn-sm btn-warning" disabled>Approved</button>
                                            </form>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">No</span>
                                            <form method="POST" action="/approveThesis" style="display:inline;">
                                                <input type="hidden" name="studentID" value="{{ student.userID }}">
                                                <button type="submit" class="btn btn-sm btn-success">Approve Thesis</button>
                                            </form>
                                        {% endif %}
                                    </li>
                                     <li>
                                        Form 1 Status:
                                         {% if student.form1_status_code == 1 %} <span class="badge bg-success">Approved</span>
                                         {% elif student.form1_status_code == -1 %} <span class="badge bg-danger">Rejected</span>
                                         {% elif student.form1_status_code == 0 %} <span class="badge bg-warning text-dark">Pending Advisor</span>
                                         {% else %} <span class="badge bg-secondary">Not Submitted / No Queue</span>
                                         {% endif %}
                                    </li>
                                    {% if student.form1_courses %}
                                        <li>Form 1 Courses:
                                            <ul class="small">
                                                {% for course in student.form1_courses %}
                                                    <li>{{ course.dept_code }} {{ course.course_number }} - {{ course.title }}</li>
                                                {% endfor %}
                                            </ul>
                                        </li>
                                    {% endif %}
                                     <li class="mt-2">
                                        <form action="/studentProf" method="POST" style="display:inline;">
                                            <input type="hidden" name="studentID" value="{{ student.userID }}">
                                            <button type="submit" class="btn btn-sm btn-outline-primary"><i class="bi bi-person-lines-fill"></i> Full Profile</button>
                                        </form>
                                    </li>
                                </ul>
                            </details>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No advisees assigned.</p>
                        {% endif %}
                    </div>

                     <div class="col-md-6">
                        <h3>Pending Form 1 Approvals</h3>
                        {% if studentsQueue %}
                            {% for student in studentsQueue %}
                            <details class="mb-2 p-2 border rounded">
                                <summary>
                                    <strong>{{ student.first_name }} {{ student.last_name }}</strong> (ID: {{ student.user_id }}, Form: {{ student.formID }})
                                     <div class="float-end">
                                        <form action="/approveForm1" method="POST" style="display:inline;">
                                            <input type="hidden" name="formID" value="{{ student.formID }}">
                                            <button type="submit" class="btn btn-sm btn-success"><i class="bi bi-check-lg"></i> Approve</button>
                                        </form>
                                        <form action="/rejectForm1" method="POST" style="display:inline;">
                                            <input type="hidden" name="formID" value="{{ student.formID }}">
                                            <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-x-lg"></i> Reject</button>
                                        </form>
                                    </div>
                                </summary>
                                <ul class="list-unstyled mt-2 ms-3 small">
                                    {% for course in coursesQueue %}
                                        {% if student.formID == course.formID %}
                                        <li>{{ course.dept_code }} {{ course.course_number }} - {{ course.title }}</li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </details>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No forms pending approval.</p>
                        {% endif %}
                    </div>
                </div> 
            </div> 
        </div>

        <div class="dashboard-section card shadow-sm">
             <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-easel2-fill"></i> Assigned Sections</h5>
            </div>
            <div class="card-body">
                {% if instructor_sections %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                             <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Title</th>
                                    <th>Term</th>
                                    <th>Enrolled</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for section in instructor_sections %}
                                <tr>
                                    <td>{{ section.dept_code }} {{ section.course_number }}</td>
                                    <td>{{ section.title }}</td>
                                    <td>{{ section.semester }} {{ section.year }}</td>
                                    <td>{{ section.enrollment_count }}</td>
                                     <td>
                                        <a href="{{ url_for('view_transcript', section_focus=section.section_id) }}" class="btn btn-sm btn-primary"><i class="bi bi-card-list"></i> View Roster</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">You are not currently assigned to instruct any sections.</p>
                {% endif %}
            </div>
        </div> 

    </div> 



</body>
</html>